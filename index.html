<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Salary Insights Dashboard — Resume-Fit (C3)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{ --bg:#f4f7fb; --card:#fff; --muted:#62707a; --accent:#2f9cf0; --pad:14px; --green:#27ae60; --orange:#f39c12; }
    body{ font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:var(--bg); color:#0f1720; margin:0; padding:22px; }
    .container{ max-width:1100px; margin:0 auto; }
    header{ margin-bottom:16px; }
    header h1{ margin:0; font-size:28px; }
    header p{ margin:6px 0 0 0; color:var(--muted); }

    .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin:14px 0; }
    .controls select, .controls input[type="text"], .controls button, .controls input[type="file"]{
      padding:8px 10px; border-radius:8px; border:1px solid #e6eef6; background:var(--card); font-size:13px;
    }

    #stats{ background:var(--card); padding:10px; border-radius:10px; box-shadow:0 6px 18px rgba(2,6,23,0.04); display:flex; gap:12px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    #insightsContainer{ display:flex; gap:14px; flex-wrap:wrap; margin-bottom:18px; }

    .insight-card{ background:var(--card); border-radius:10px; padding:12px; min-width:230px; box-shadow:0 6px 18px rgba(2,6,23,0.04); }
    .insight-card h3{ margin:0 0 8px 0; font-size:15px; }
    .small-muted{ color:var(--muted); font-size:13px; }

    .bar-bg{ background:#eef6fb; border-radius:8px; height:12px; overflow:hidden; margin-top:6px; }
    .bar-fill{ height:12px; background:var(--accent); border-radius:8px 0 0 8px; }

    .charts{ display:grid; grid-template-columns:1fr 1fr; gap:16px; }
    .chart-card{ background:var(--card); padding:12px; border-radius:10px; box-shadow:0 6px 18px rgba(2,6,23,0.04); min-height:300px; }
    canvas{ width:100% !important; height:260px !important; }

    footer{ margin-top:18px; color:var(--muted); font-size:13px; text-align:center; }

    /* Resume fit visual */
    .fit-score{ font-size:28px; font-weight:700; color:var(--accent); }
    .recommend-list{ margin:8px 0 0 0; padding-left:16px; }
    .chip{ display:inline-block; padding:5px 8px; background:#f1f6fb; border-radius:8px; margin:4px; font-size:13px; color:#122; }
    @media(max-width:900px){ .charts{ grid-template-columns:1fr; } }
  </style>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
  <div class="container">
    <header>
      <h1>Salary Insights Dashboard — Resume-Fit (C3)</h1>
      <p>Upload a salary CSV (must include columns: top_skills, demand_score, postings, annual_salary_inr)</p>
    </header>

    <section class="controls">
      <input id="fileInput" type="file" accept=".csv" />
      <select id="roleFilter"><option value="">All Roles</option></select>
      <select id="countryFilter"><option value="">All Countries</option></select>
      <select id="expFilter">
        <option value="">All Experience</option>
        <option value="0-1">0–1</option>
        <option value="1-3">1–3</option>
        <option value="3-5">3–5</option>
        <option value="5+">5+</option>
      </select>
      <select id="skillLevelFilter"><option value="">All levels</option><option value="novice">Novice</option><option value="mid">Mid</option><option value="senior">Senior</option></select>
      <input id="userSkills" placeholder="Your skills (comma separated)" type="text" style="min-width:260px" />
      <button id="analyzeBtn">Analyze</button>
      <button id="downloadBtn">Download Filtered CSV</button>
    </section>

    <div id="stats">
      <strong>Stats:</strong>
      <span id="avg">Avg: -</span>
      <span id="median">Median: -</span>
      <span id="min">Min: -</span>
      <span id="max">Max: -</span>
    </div>

    <div id="insightsContainer">
      <!-- Cards will be rendered here -->
    </div>

    <section class="charts">
      <div class="chart-card"><canvas id="salaryDist"></canvas></div>
      <div class="chart-card"><canvas id="salaryByExp"></canvas></div>
      <div class="chart-card"><canvas id="cityBar"></canvas></div>
      <div class="chart-card" id="summaryLower"></div>
    </section>

    <footer>
      <small>Built with ❤️ • Resume-Fit algorithm (transparent weights) • Option C3</small>
    </footer>
  </div>

<script>
// ---------- Utilities ----------
function toNumber(v){ return v === '' || v === null || v === undefined ? NaN : +v; }
function medianCalc(arr){ const s = arr.slice().sort((a,b)=>a-b); const n=s.length; if(n===0) return NaN; const m=Math.floor(n/2); return n%2 ? s[m] : (s[m-1]+s[m])/2; }
function parseSkills(text){ if(!text) return []; return text.toString().split(/[;,|\/]+/).map(s=>s.trim().toLowerCase()).filter(Boolean); }
function uniq(arr){ return Array.from(new Set(arr)); }
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function safeVal(r, keys){ for(const k of keys) if(r[k] !== undefined && r[k] !== null) return r[k]; return ''; }

// ---------- State & DOM ----------
let rawData = []; let filtered = [];
const fileInput = document.getElementById('fileInput');
const roleFilter = document.getElementById('roleFilter');
const countryFilter = document.getElementById('countryFilter');
const expFilter = document.getElementById('expFilter');
const skillLevelFilter = document.getElementById('skillLevelFilter');
const userSkillsInput = document.getElementById('userSkills');
const analyzeBtn = document.getElementById('analyzeBtn');
const downloadBtn = document.getElementById('downloadBtn');

const avgEl = document.getElementById('avg'), medianEl = document.getElementById('median'), minEl = document.getElementById('min'), maxEl = document.getElementById('max');
const insightsContainer = document.getElementById('insightsContainer');

// ---------- Charts ----------
let salaryDistChart, salaryByExpChart, cityBarChart;
function createChart(ctx, cfg){ return new Chart(ctx, cfg); }
function buildCharts(){
  salaryDistChart = createChart(document.getElementById('salaryDist'), { type:'bar', data:{labels:[], datasets:[{label:'Count', data:[], backgroundColor:'rgba(47,156,240,0.6)'}]}, options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}});
  salaryByExpChart = createChart(document.getElementById('salaryByExp'), { type:'bar', data:{labels:[], datasets:[{label:'Avg Salary', data:[], backgroundColor:'rgba(47,156,240,0.6)'}]}, options:{responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}});
  cityBarChart = createChart(document.getElementById('cityBar'), { type:'bar', data:{labels:[], datasets:[{label:'Avg Salary', data:[], backgroundColor:'rgba(47,156,240,0.6)'}]}, options:{indexAxis:'y', responsive:true, plugins:{legend:{display:false}}, scales:{x:{beginAtZero:true}}}});
}
buildCharts();

// ---------- Read & map CSV ----------
function mapRow(r){
  return {
    role: (safeVal(r, ['role','Role','job','Job'])||'').toString().trim(),
    country: (safeVal(r, ['country','Country'])||'').toString().trim(),
    city: (safeVal(r, ['city','City'])||'').toString().trim(),
    experience_years: (safeVal(r, ['experience_years','experience','Experience'])||'').toString().trim(),
    annual_salary_inr: (safeVal(r, ['annual_salary_inr','annual_salary','salary','Salary'])||'').toString().replace(/,/g,'').trim(),
    top_skills: (safeVal(r, ['top_skills','Top_skills','skills','Skills'])||'').toString().trim(),
    demand_score: (safeVal(r, ['demand_score','Demand_score'])||'').toString().trim(),
    postings: (safeVal(r, ['postings','Postings'])||'').toString().trim()
  };
}

fileInput.addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  Papa.parse(f, { header:true, skipEmptyLines:true, complete(results){
    rawData = results.data.map(mapRow);
    updateFiltersUI(); applyFilters();
  }});
});

// fetch sample file if present
fetch('data/sample_salaries.csv').then(r=>r.text()).then(txt=>{
  Papa.parse(txt, { header:true, skipEmptyLines:true, complete(res){
    rawData = res.data.map(mapRow);
    updateFiltersUI(); applyFilters();
  }});
}).catch(()=>{/*no sample*/});

// ---------- Filters UI ----------
function updateFiltersUI(){
  const roles = uniq(rawData.map(r=>r.role)).filter(Boolean).sort();
  const countries = uniq(rawData.map(r=>r.country)).filter(Boolean).sort();
  roleFilter.innerHTML = '<option value="">All Roles</option>' + roles.map(x=>`<option>${x}</option>`).join('');
  countryFilter.innerHTML = '<option value="">All Countries</option>' + countries.map(x=>`<option>${x}</option>`).join('');
}

[roleFilter, countryFilter, expFilter, skillLevelFilter].forEach(el => { if(el) el.addEventListener('change', applyFilters); });

// ---------- Apply filters ----------
function applyFilters(){
  const role = roleFilter.value, country = countryFilter.value, exp = expFilter.value, level = skillLevelFilter.value;
  filtered = rawData.filter(r=>{
    if(role && r.role !== role) return false;
    if(country && r.country !== country) return false;
    const yrs = toNumber(r.experience_years);
    if(!isNaN(yrs) && exp){
      if(exp==='0-1' && !(yrs>=0 && yrs<=1)) return false;
      if(exp==='1-3' && !(yrs>1 && yrs<=3)) return false;
      if(exp==='3-5' && !(yrs>3 && yrs<=5)) return false;
      if(exp==='5+' && !(yrs>5)) return false;
    }
    if(level){
      const lv = (r.skill_level||'').toLowerCase();
      if(lv) { if(lv !== level) return false; }
      else {
        if(level==='novice' && !(yrs <= 1)) return false;
        if(level==='mid' && !(yrs > 1 && yrs <= 3)) return false;
        if(level==='senior' && !(yrs > 3)) return false;
      }
    }
    return true;
  });
  renderStats(); renderCharts(); renderInsights();
}

// ---------- Stats & Charts ----------
function renderStats(){
  const salaries = filtered.map(r=>toNumber(r.annual_salary_inr)).filter(v=>!isNaN(v));
  if(salaries.length===0){ avgEl.textContent = medianEl.textContent = minEl.textContent = maxEl.textContent = "-"; return; }
  const avgV = Math.round(salaries.reduce((a,b)=>a+b,0)/salaries.length);
  const medV = Math.round(medianCalc(salaries));
  const minV = Math.round(Math.min(...salaries));
  const maxV = Math.round(Math.max(...salaries));
  avgEl.textContent = `Avg: ₹${avgV.toLocaleString()}`; medianEl.textContent = `Median: ₹${medV.toLocaleString()}`; minEl.textContent = `Min: ₹${minV.toLocaleString()}`; maxEl.textContent = `Max: ₹${maxV.toLocaleString()}`;
}

function renderCharts(){
  const salaries = filtered.map(r=>toNumber(r.annual_salary_inr)).filter(v=>!isNaN(v));
  // distribution
  let labels=[]; let counts=[];
  if(salaries.length){
    const minV = Math.min(...salaries); const maxV = Math.max(...salaries); const buckets=6; const range=maxV-minV || 1; const size = range/buckets;
    counts = Array(buckets).fill(0); labels = [];
    for(let i=0;i<buckets;i++){ const a=Math.round(minV + i*size); const b=Math.round(minV + (i+1)*size); labels.push(`₹${a.toLocaleString()} - ₹${b.toLocaleString()}`); }
    salaries.forEach(v=>{ let idx = Math.floor((v-minV)/size); if(idx>=buckets) idx=buckets-1; counts[idx]++; });
  }
  salaryDistChart.data.labels = labels; salaryDistChart.data.datasets[0].data = counts; salaryDistChart.update();

  // by experience
  const groups = {}; filtered.forEach(r=>{ const yrs = toNumber(r.experience_years); const sal = toNumber(r.annual_salary_inr); if(isNaN(yrs)||isNaN(sal)) return; let b='Unknown'; if(yrs<=1) b='0-1'; else if(yrs<=3) b='1-3'; else if(yrs<=5) b='3-5'; else b='5+'; if(!groups[b]) groups[b]=[]; groups[b].push(sal); });
  const expLabels = Object.keys(groups).sort(); const expAvgs = expLabels.map(k=>Math.round(groups[k].reduce((a,b)=>a+b,0)/groups[k].length));
  salaryByExpChart.data.labels = expLabels; salaryByExpChart.data.datasets[0].data = expAvgs; salaryByExpChart.update();

  // city
  const city = {}; filtered.forEach(r=>{ const c = r.city||'Unknown'; const s=toNumber(r.annual_salary_inr); if(isNaN(s)) return; if(!city[c]) city[c]=[]; city[c].push(s); });
  const cityArr = Object.entries(city).map(([c,arr])=>({city:c, avg: arr.reduce((a,b)=>a+b,0)/arr.length})).sort((a,b)=>b.avg-a.avg).slice(0,8);
  cityBarChart.data.labels = cityArr.map(x=>x.city); cityBarChart.data.datasets[0].data = cityArr.map(x=>Math.round(x.avg)); cityBarChart.update();
}

// ---------- Insights & Resume-Fit C3 ----------

function computeInsights(){
  // compute global min/max salary across rawData for normalization
  const allSalaries = rawData.map(r=>toNumber(r.annual_salary_inr)).filter(v=>!isNaN(v));
  const globalMin = allSalaries.length ? Math.min(...allSalaries) : 0;
  const globalMax = allSalaries.length ? Math.max(...allSalaries) : (globalMin || 1);

  // For filtered rows, compute aggregates
  const rows = filtered.slice();
  const salaries = rows.map(r=>toNumber(r.annual_salary_inr)).filter(v=>!isNaN(v));
  const minV = salaries.length ? Math.min(...salaries) : null;
  const medV = salaries.length ? Math.round(medianCalc(salaries)) : null;
  const maxV = salaries.length ? Math.max(...salaries) : null;
  const avgV = salaries.length ? Math.round(salaries.reduce((a,b)=>a+b,0)/salaries.length) : null;

  // demand
  const postings = rows.reduce((s,r)=>s + (isNaN(Number(r.postings)) ? 0 : Number(r.postings)), 0);
  const avgDemandScore = rows.length ? Math.round(rows.reduce((s,r)=>s + (isNaN(Number(r.demand_score))?0:Number(r.demand_score)),0)/rows.length) : 0;

  // top skills aggregated
  const skillCounts = {};
  rows.forEach(r=>{
    const sk = parseSkills(r.top_skills || '');
    const uniqSk = uniq(sk);
    uniqSk.forEach(s=> skillCounts[s] = (skillCounts[s]||0)+1);
  });
  const topSkills = Object.entries(skillCounts).sort((a,b)=>b[1]-a[1]).slice(0,8).map(x=>x[0]);

  return { rows, salaries, minV, medV, maxV, avgV, postings, avgDemandScore, topSkills, globalMin, globalMax };
}

// Resume Fit function (C3)
function computeResumeFit(insights, userSkillsText){
  const required = insights.topSkills.slice(0,8); // required list
  const userSkills = parseSkills(userSkillsText || '');
  const matched = required.filter(s => userSkills.includes(s));
  const missing = required.filter(s => !userSkills.includes(s));
  const skillMatchPct = required.length ? Math.round((matched.length / required.length) * 100) : 0;

  // demand factor: average demand score normalized 0-1
  const demandFactor = insights.avgDemandScore ? clamp(insights.avgDemandScore / 100, 0,1) : 0;

  // salary factor: average salary normalized within global dataset (0-1)
  const avgSal = insights.avgV || 0;
  const salaryNorm = (avgSal - insights.globalMin) / (insights.globalMax - insights.globalMin || 1);
  const salaryFactor = clamp(salaryNorm, 0,1);

  // final score: 70% skills, 20% demand, 10% salary
  // compute digit-by-digit to be safe:
  const skillComponent = skillMatchPct * 0.70;
  const demandComponent = (demandFactor * 100) * 0.20;
  const salaryComponent = (salaryFactor * 100) * 0.10;
  let score = skillComponent + demandComponent + salaryComponent;
  score = Math.round(clamp(score, 0, 100));

  // Recommendation summary
  let recommended = missing.slice(0,6);
  const tip = recommended.length ? `Focus on learning: ${recommended.join(', ')}.` : 'You already have core skills — consider building projects to showcase them.';

  return { score, required, matched, missing, recommended, tip, components:{skillComponent:Math.round(skillComponent), demandComponent:Math.round(demandComponent), salaryComponent:Math.round(salaryComponent)} };
}

function renderInsights(){
  const ins = computeInsights();
  const userText = userSkillsInput.value || '';
  // clear container
  insightsContainer.innerHTML = '';

  // Salary card
  const salaryCard = document.createElement('div'); salaryCard.className='insight-card';
  salaryCard.innerHTML = `<h3>Salary Range</h3>
    <div class="small-muted">Min: ${ins.minV ? '₹'+ins.minV.toLocaleString() : '—'} &nbsp; Median: ${ins.medV ? '₹'+ins.medV.toLocaleString() : '—'} &nbsp; Max: ${ins.maxV ? '₹'+ins.maxV.toLocaleString() : '—'}</div>
    <div class="small-muted">Avg: ${ins.avgV ? '₹'+ins.avgV.toLocaleString() : '—'}</div>`;
  insightsContainer.appendChild(salaryCard);

  // Market Demand card
  const demandCard = document.createElement('div'); demandCard.className='insight-card';
  demandCard.innerHTML = `<h3>Market Demand</h3>
    <div class="small-muted">Postings: <strong>${ins.postings}</strong></div>
    <div class="small-muted">Avg demand score: <strong>${ins.avgDemandScore}/100</strong></div>
    <div class="bar-bg" aria-hidden="true"><div class="bar-fill" style="width:${ins.avgDemandScore}%"></div></div>`;
  insightsContainer.appendChild(demandCard);

  // Skill Gap card
  const skillCard = document.createElement('div'); skillCard.className='insight-card';
  skillCard.innerHTML = `<h3>Skill Gap</h3>
    <div class="small-muted">Top skills: ${ins.topSkills.length?ins.topSkills.join(', '):'—'}</div>
    <div class="small-muted">Tip: Provide your skills and press Analyze to see gap</div>`;
  insightsContainer.appendChild(skillCard);

  // Resume-Fit (C3) card
  const fit = computeResumeFit(ins, userText);
  const fitCard = document.createElement('div'); fitCard.className='insight-card';
  fitCard.innerHTML = `<h3>Resume-Fit</h3>
    <div class="fit-score">${fit.score}%</div>
    <div class="small-muted">Match components — Skills: ${fit.components.skillComponent} | Demand: ${fit.components.demandComponent} | Salary: ${fit.components.salaryComponent}</div>
    <div style="margin-top:8px;"><strong>Missing / Recommended:</strong></div>
    <div>${fit.recommended.length ? fit.recommended.map(s=>`<span class="chip">${s}</span>`).join('') : '<div class="small-muted">None — Good fit</div>'}</div>
    <div style="margin-top:8px;" class="small-muted"><strong>Recommendation:</strong> ${fit.tip}</div>`;
  insightsContainer.appendChild(fitCard);

  // Also append a more detailed report area in the lower summary card
  const lower = document.getElementById('summaryLower');
  if(lower){
    lower.innerHTML = `<h3 style="margin-top:0;">Resume-Fit Report</h3>
      <div class="small-muted">Required skills (top): ${ins.topSkills.length?ins.topSkills.join(', '):'—'}</div>
      <div class="small-muted">Your skills: ${(parseSkills(userText)||[]).join(', ') || '—'}</div>
      <div style="margin-top:8px;"><strong>Missing skills details:</strong></div>
      <div>${fit.missing.length ? fit.missing.map(s=>`<div class="small-muted">• ${s}</div>`).join('') : '<div class="small-muted">You match all top skills.</div>'}</div>
      <div style="margin-top:8px;"><strong>Actionable next steps:</strong></div>
      <ol>
        <li>Learn the recommended skills listed above and add small projects that demonstrate them.</li>
        <li>Update your resume summary to include matched keywords (e.g. ${ins.topSkills.slice(0,3).join(', ')}).</li>
        <li>Apply to roles with demand score >= ${Math.max(50, Math.round(ins.avgDemandScore))} for better chances.</li>
      </ol>`;
  }
}

// ---------- Events ----------
analyzeBtn.addEventListener('click', e=>{ e.preventDefault(); renderInsights(); });
downloadBtn.addEventListener('click', ()=>{ downloadFilteredCSV(); });

// download helper
function downloadFilteredCSV(){
  const rows = filtered.map(r=>({
    role: r.role, country: r.country, city: r.city, experience_years: r.experience_years,
    annual_salary_inr: r.annual_salary_inr, top_skills: r.top_skills, demand_score: r.demand_score, postings: r.postings
  }));
  const csv = Papa.unparse(rows);
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'filtered_salaries.csv'; a.click(); URL.revokeObjectURL(url);
}

// ---------- Initial run ----------
renderInsights(); // will show placeholders when no data yet

</script>
</body>
</html>
