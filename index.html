<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Salary Insights Dashboard — Starter</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="assets/style.css" />
  
  <!-- CSV parser -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  
  <!-- Chart.js library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>

  <div class="container">
    <header>
      <h1>Salary Insights Dashboard</h1>
      <p>Upload a salary CSV or use the sample data</p>
    </header>

    <!-- Controls -->
    <section class="controls">
      <input id="fileInput" type="file" accept=".csv" />

      <select id="roleFilter"><option value="">All Roles</option></select>
      <select id="countryFilter"><option value="">All Countries</option></select>

      <select id="expFilter">
        <option value="">All Experience</option>
        <option value="0-1">0–1 years</option>
        <option value="1-3">1–3 years</option>
        <option value="3-5">3–5 years</option>
        <option value="5+">5+ years</option>
      </select>

      <button id="downloadBtn">Download Filtered CSV</button>
    </section>

    <!-- Summary -->
    <section class="summary">
      <div id="stats">
        <strong>Stats:</strong>
        <span id="avg">Avg: -</span>
        <span id="median">Median: -</span>
        <span id="min">Min: -</span>
        <span id="max">Max: -</span>
      </div>
    </section>

    <!-- Charts -->
    <section class="charts">
      <div class="chart-card"><canvas id="salaryDist"></canvas></div>
      <div class="chart-card"><canvas id="salaryByExp"></canvas></div>
      <div class="chart-card"><canvas id="cityBar"></canvas></div>
    </section>

    <footer>
      <small>Dashboard created by You • Add AI insights later</small>
    </footer>
  </div>


<script>
// --- UTILITY FUNCTIONS ---
function toNumber(v){ return v === '' || v === null || v === undefined ? NaN : +v; }
function medianCalc(arr){
  const sorted = arr.slice().sort((a,b)=>a-b);
  const n = sorted.length;
  if(n===0) return NaN;
  const mid = Math.floor(n/2);
  return n%2 ? sorted[mid] : (sorted[mid-1]+sorted[mid]) / 2;
}
function downloadCSV(rows, filename='filtered.csv'){
  const csv = Papa.unparse(rows);
  const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; 
  a.download = filename; 
  a.click();
  URL.revokeObjectURL(url);
}


// --- STATE ---
let rawData = [];
let filtered = [];

// DOM elements
const fileInput = document.getElementById('fileInput');
const roleFilter = document.getElementById('roleFilter');
const countryFilter = document.getElementById('countryFilter');
const expFilter = document.getElementById('expFilter');
const downloadBtn = document.getElementById('downloadBtn');

// stat elements (fix: make sure these IDs exist in HTML)
const avg = document.getElementById('avg');
const median = document.getElementById('median');
const min = document.getElementById('min');
const max = document.getElementById('max');


// --- CHART VARIABLES ---
let salaryDistChart, salaryByExpChart, cityBarChart;


// --- INITIALIZE CHARTS ---
function createChart(ctx, cfg){ return new Chart(ctx, cfg); }

function buildCharts(){
  salaryDistChart = createChart(
    document.getElementById('salaryDist'),
    {
      type: 'bar',
      data: { labels: [], datasets: [{ label: 'Count', data: [] }] },
      options: { responsive:true, plugins:{legend:{display:false}} }
    }
  );

  salaryByExpChart = createChart(
    document.getElementById('salaryByExp'),
    {
      type: 'bar',
      data: { labels: [], datasets: [{ label: 'Avg Salary', data: [] }] },
      options: { responsive:true }
    }
  );

  cityBarChart = createChart(
    document.getElementById('cityBar'),
    {
      type: 'bar',
      data: { labels: [], datasets: [{ label: 'Avg Salary', data: [] }] },
      options: { indexAxis:'y', responsive:true }
    }
  );
}


// --- UPDATE FILTER OPTIONS ---
function updateFiltersUI(){
  const roles = Array.from(new Set(rawData.map(r=>r.role))).sort();
  const countries = Array.from(new Set(rawData.map(r=>r.country))).sort();

  roleFilter.innerHTML = '<option value="">All Roles</option>' +
    roles.map(r=>`<option>${r}</option>`).join('');

  // fixed: use 'c' as the map parameter, not an undefined variable
  countryFilter.innerHTML = '<option value="">All Countries</option>' +
    countries.map(c=>`<option>${c}</option>`).join('');
}



// --- APPLY FILTERS ---
function applyFilters(){
  const role = roleFilter.value;
  const country = countryFilter.value;
  const exp = expFilter.value;

  filtered = rawData.filter(r=>{
    if(role && r.role !== role) return false;
    if(country && r.country !== country) return false;

    const yrs = toNumber(r.experience_years);
    if(!isNaN(yrs) && exp){
      if(exp==='0-1' && !(yrs>=0 && yrs<=1)) return false;
      if(exp==='1-3' && !(yrs>1 && yrs<=3)) return false;
      if(exp==='3-5' && !(yrs>3 && yrs<=5)) return false;
      if(exp==='5+' && !(yrs>5)) return false;
    }
    return true;
  });

  renderStats();
  renderCharts();
}


// --- SUMMARY STATS ---
function renderStats(){
  const salaries = filtered
      .map(r=>toNumber(r.annual_salary_inr))
      .filter(v=>!isNaN(v));

  if(salaries.length===0){
    avg.textContent = median.textContent = min.textContent = max.textContent = "-";
    return;
  }

  const avgV = Math.round(salaries.reduce((a,b)=>a+b,0)/salaries.length);
  const medV = Math.round(medianCalc(salaries));
  const minV = Math.round(Math.min(...salaries));
  const maxV = Math.round(Math.max(...salaries));

  avg.textContent = `Avg: ₹${avgV.toLocaleString()}`;
  median.textContent = `Median: ₹${medV.toLocaleString()}`;
  min.textContent = `Min: ₹${minV.toLocaleString()}`;
  max.textContent = `Max: ₹${maxV.toLocaleString()}`;
}


// --- RENDER CHARTS ---
function renderCharts(){
  const salaries = filtered.map(r=>toNumber(r.annual_salary_inr)).filter(v=>!isNaN(v));

  // Salary Distribution
  let labels = [];
  let counts = [];

  if(salaries.length){
    const minV = Math.min(...salaries);
    const maxV = Math.max(...salaries);
    const bucketCount = 8;
    const range = maxV - minV;

    const bucketSize = range / bucketCount;

    labels = [];
    counts = Array(bucketCount).fill(0);

    for(let i=0;i<bucketCount;i++){
      const start = Math.round(minV + i*bucketSize);
      const end = Math.round(minV + (i+1)*bucketSize);
      labels.push(`₹${start} - ₹${end}`);
    }

    salaries.forEach(v=>{
      let index = Math.floor((v - minV) / bucketSize);
      if(index >= bucketCount) index = bucketCount - 1;
      counts[index]++;
    });
  }

  salaryDistChart.data.labels = labels;
  salaryDistChart.data.datasets[0].data = counts;
  salaryDistChart.update();


  // Salary by Experience Bucket
  const expGroups = {};
  filtered.forEach(r=>{
    const yrs = toNumber(r.experience_years);
    const sal = toNumber(r.annual_salary_inr);
    if(isNaN(yrs) || isNaN(sal)) return;

    let bucket = "Unknown";
    if(yrs <= 1) bucket = "0-1";
    else if(yrs <= 3) bucket = "1-3";
    else if(yrs <= 5) bucket = "3-5";
    else bucket = "5+";

    if(!expGroups[bucket]) expGroups[bucket] = [];
    expGroups[bucket].push(sal);
  });

  const expLabels = Object.keys(expGroups).sort();
  const expAvgs = expLabels.map(b =>
    Math.round(expGroups[b].reduce((a,b)=>a+b,0) / expGroups[b].length)
  );

  salaryByExpChart.data.labels = expLabels;
  salaryByExpChart.data.datasets[0].data = expAvgs;
  salaryByExpChart.update();


  // Salary by City
  const cityGroups = {};
  filtered.forEach(r=>{
    const city = r.city || "Unknown";
    const sal = toNumber(r.annual_salary_inr);
    if(isNaN(sal)) return;

    if(!cityGroups[city]) cityGroups[city] = [];
    cityGroups[city].push(sal);
  });

  const cityData = Object.entries(cityGroups)
    .map(([city,arr])=>({
      city,
      avg: arr.reduce((a,b)=>a+b,0)/arr.length
    }))
    .sort((a,b)=>b.avg - a.avg)
    .slice(0,10);

  cityBarChart.data.labels = cityData.map(x=>x.city);
  cityBarChart.data.datasets[0].data = cityData.map(x=>Math.round(x.avg));
  cityBarChart.update();
}


// --- EVENT LISTENERS ---

fileInput.addEventListener('change', (e)=>{
  const file = e.target.files[0];
  if(!file) return;

  Papa.parse(file, {
    header:true,
    skipEmptyLines:true,
    complete: function(results){
      rawData = results.data.map(r=>({
        role: (r.role || r.Role || "").trim(),
        country: (r.country || r.Country || "").trim(),
        city: (r.city || r.City || "").trim(),
        experience_years: (r.experience_years || r.experience || "").trim(),
        annual_salary_inr: (r.annual_salary_inr || r.salary || "").trim()
      }));
      updateFiltersUI();
      applyFilters();
    }
  });
});

[roleFilter, countryFilter, expFilter].forEach(el =>
  el.addEventListener('change', applyFilters)
);

downloadBtn.addEventListener('click', () => downloadCSV(filtered));


// --- INITIAL LOAD (sample CSV) ---
fetch("data/sample_salaries.csv")
  .then(res => res.text())
  .then(txt => {
    Papa.parse(txt, {
      header:true,
      skipEmptyLines:true,
      complete(res){
        rawData = res.data.map(r=>({
          role: (r.role || '').trim(),
          country: (r.country || '').trim(),
          city: (r.city || '').trim(),
          experience_years: (r.experience_years || '').trim(),
          annual_salary_inr: (r.annual_salary_inr || '').trim()
        }));
        updateFiltersUI();
        applyFilters();
      }
    });
  });


// Build Chart Canvases
buildCharts();

</script>
</body>
</html>
